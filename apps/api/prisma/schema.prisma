// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String?
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  isAdmin       Boolean   @default(false)
  
  // Profile
  language      String    @default("ko")
  theme         String    @default("light")
  contact       String?


  // Relations
  ownedSpreadsheets   Spreadsheet[]   @relation("SpreadsheetOwner")
  permissions         Permission[]
  comments            Comment[]
  versions            Version[]
  sessions            Session[]
  auditLogs           AuditLog[]
  favorites           Favorite[]
  
  roleId              String?
  role                Role?           @relation(fields: [roleId], references: [id])
  flowPermissions     FlowPermission[]
  
  // Phase 1: Advanced Features
  sheetPermissions    SheetPermission[]
  revisionLogs        RevisionLog[]
  sheetSnapshots      SheetSnapshot[]
}

model Session {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshToken  String    @unique
  expiresAt     DateTime
  createdAt     DateTime  @default(now())

  @@map("sessions")
}

// Spreadsheet model
model Spreadsheet {
  id            String    @id @default(uuid())
  name          String
  ownerId       String
  owner         User      @relation("SpreadsheetOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  isPublic      Boolean   @default(false)
  publicToken   String?   @unique
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // For soft delete

  // Relations
  sheets        Sheet[]
  permissions   Permission[]
  versions      Version[]
  favorites     Favorite[]
  webhooks      Webhook[]
  eventRules    EventRule[]
  flows         Flow[]
  embedConfig   EmbedConfig?
  
  // Phase 3: Advanced Features
  customCommands  CustomCommand[]
  masterViews     MasterView[]

  @@map("spreadsheets")
}

// Embed Configuration - 시트 임베딩 설정
model EmbedConfig {
  id              String      @id @default(uuid())
  spreadsheetId   String      @unique
  spreadsheet     Spreadsheet @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  embedToken      String      @unique @default(uuid())
  enabled         Boolean     @default(true)
  
  // 표시 옵션
  showToolbar     Boolean     @default(false)
  showTabs        Boolean     @default(true)
  showGridlines   Boolean     @default(true)
  
  // 제한 옵션
  allowedDomains  String[]    @default([])  // 빈 배열 = 모든 도메인 허용
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@map("embed_configs")
}

model Favorite {
  id            String      @id @default(uuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  spreadsheetId String
  spreadsheet   Spreadsheet @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  createdAt     DateTime    @default(now())

  @@unique([userId, spreadsheetId])
  @@map("favorites")
}

// Sheet model (tabs within a spreadsheet)
model Sheet {
  id              String    @id @default(uuid())
  spreadsheetId   String
  spreadsheet     Spreadsheet @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  name            String
  index           Int       @default(0)
  rowCount        Int       @default(1000)
  colCount        Int       @default(26)
  frozenRows      Int       @default(0)
  frozenCols      Int       @default(0)
  defaultRowHeight Int      @default(25)
  defaultColWidth  Int      @default(100)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  cells           Cell[]
  comments        Comment[]
  rowMeta         RowMeta[]
  colMeta         ColMeta[]
  charts          Chart[]
  pivotTables     PivotTable[]
  
  // Phase 1: Advanced Features
  sheetPermissions      SheetPermission[]
  revisionLogs          RevisionLog[]
  conditionalRules      ConditionalRule[]
  sourceReferences      CrossSheetReference[] @relation("SourceReferences")
  targetReferences      CrossSheetReference[] @relation("TargetReferences")
  sheetSnapshots        SheetSnapshot[]
  filterProfiles        FilterProfile[]
  sheetAutomations      SheetAutomation[]

  @@unique([spreadsheetId, index])
  @@map("sheets")
}

// Cell model
model Cell {
  id            String    @id @default(uuid())
  sheetId       String
  sheet         Sheet     @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  row           Int
  col           Int
  value         Json?
  formula       String?
  format        Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([sheetId, row, col])
  @@index([sheetId])
  @@map("cells")
}

// Chart model - 시트에 포함된 차트
model Chart {
  id              String    @id @default(uuid())
  sheetId         String
  sheet           Sheet     @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  type            String    // bar, line, pie, doughnut
  x               Int       @default(100)
  y               Int       @default(100)
  width           Int       @default(400)
  height          Int       @default(300)
  data            Json      // 차트 데이터 (labels, datasets)
  options         Json?     // 차트 옵션
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([sheetId])
  @@map("charts")
}

// PivotTable model - 피벗테이블 설정
model PivotTable {
  id              String    @id @default(uuid())
  sheetId         String
  sheet           Sheet     @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  name            String?
  config          Json      // PivotConfig (rows, columns, values, aggregation)
  sourceRange     String?   // 원본 데이터 범위 (예: "A1:D10")
  targetCell      String?   // 결과가 배치될 시작 셀 (예: "F1")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([sheetId])
  @@map("pivot_tables")
}

// Row metadata (height, hidden)
model RowMeta {
  id            String    @id @default(uuid())
  sheetId       String
  sheet         Sheet     @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  row           Int
  height        Int?
  hidden        Boolean   @default(false)

  @@unique([sheetId, row])
  @@map("row_meta")
}

// Column metadata (width, hidden)
model ColMeta {
  id            String    @id @default(uuid())
  sheetId       String
  sheet         Sheet     @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  col           Int
  width         Int?
  hidden        Boolean   @default(false)

  @@unique([sheetId, col])
  @@map("col_meta")
}

// Permission model
model Permission {
  id              String    @id @default(uuid())
  spreadsheetId   String
  spreadsheet     Spreadsheet @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  userId          String?
  user            User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  email           String?   // For sharing with non-registered users
  role            PermissionRole
  inviteToken     String?   @unique
  expiresAt       DateTime?
  createdAt       DateTime  @default(now())

  @@unique([spreadsheetId, userId])
  @@unique([spreadsheetId, email])
  @@map("permissions")
}

enum PermissionRole {
  VIEWER
  COMMENTER
  EDITOR
  OWNER
}

// Version/History model
model Version {
  id              String    @id @default(uuid())
  spreadsheetId   String
  spreadsheet     Spreadsheet @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  name            String?
  snapshot        Json      // CRDT state or cell data snapshot
  createdById     String
  createdBy       User      @relation(fields: [createdById], references: [id])
  createdAt       DateTime  @default(now())

  @@index([spreadsheetId, createdAt(sort: Desc)])
  @@map("versions")
}

// Comment model
model Comment {
  id              String    @id @default(uuid())
  sheetId         String
  sheet           Sheet     @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  row             Int
  col             Int
  content         String
  authorId        String
  author          User      @relation(fields: [authorId], references: [id])
  parentId        String?
  parent          Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies         Comment[] @relation("CommentReplies")
  resolved        Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([sheetId, row, col])
  @@map("comments")
}

// System Configuration (Global Settings)
model SystemConfig {
  key           String    @id
  value         String // JSON string or simple value
  description   String?
  updatedAt     DateTime  @updatedAt

  @@map("system_config")
}

// Audit Logs
model AuditLog {
  id            String    @id @default(uuid())
  userId        String?
  user          User?     @relation(fields: [userId], references: [id])
  action        String    // e.g., "USER_CREATED", "SHEET_DELETED"
  resource      String?   // e.g., "User: 123", "Sheet: ABC"
  details       Json?     // Metadata
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime  @default(now())

  @@index([createdAt(sort: Desc)])
  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}

// Role Based Access Control
model Role {
  id            String    @id @default(uuid())
  name          String    @unique // e.g., "ADMIN", "MANAGER", "USER"
  description   String?
  permissions   Json      // List of allowed actions or permission matrix
  isSystem      Boolean   @default(false) // System roles cannot be deleted
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  users         User[]

  @@map("roles")
}

// System Notices / Announcements
model Notice {
  id            String    @id @default(uuid())
  title         String
  content       String    @db.Text
  type          NoticeType @default(INFO)
  active        Boolean   @default(true)
  startDate     DateTime?
  endDate       DateTime?
  authorId      String
  // author        User      @relation(fields: [authorId], references: [id]) // Optional: link to creator
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("notices")
}

enum NoticeType {
  INFO
  WARNING
  URGENT
  MAINTENANCE
}

// Spreadsheet Templates
model Template {
  id            String    @id @default(uuid())
  name          String
  description   String?
  category      String    @default("General")
  data          Json      // The spreadsheet data structure
  thumbnail     String?   // URL or base64
  isPublic      Boolean   @default(true)
  order         Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("templates")
}

// =====================================================
// WORKFLOW AUTOMATION SYSTEM
// =====================================================

// 웹훅 설정
model Webhook {
  id              String          @id @default(uuid())
  spreadsheetId   String
  spreadsheet     Spreadsheet     @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  name            String
  url             String
  secret          String
  events          String[]        // 이벤트 타입 배열
  
  // 재시도 정책
  maxRetries      Int             @default(3)
  retryBackoff    String          @default("exponential") // linear, exponential
  
  active          Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  eventRules      EventRule[]
  executions      WebhookExecution[]
  deadLetterQueue DeadLetterItem[]

  @@map("webhooks")
}

// 웹훅 실행 로그
model WebhookExecution {
  id              String          @id @default(uuid())
  webhookId       String
  webhook         Webhook         @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  transactionId   String
  payload         Json
  response        Json?
  statusCode      Int?
  success         Boolean         @default(false)
  retryCount      Int             @default(0)
  executedAt      DateTime        @default(now())

  @@index([webhookId, executedAt(sort: Desc)])
  @@map("webhook_executions")
}

// Dead-letter 큐
model DeadLetterItem {
  id              String          @id @default(uuid())
  webhookId       String
  webhook         Webhook         @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  payload         Json
  error           String
  createdAt       DateTime        @default(now())

  @@map("dead_letter_queue")
}

// 이벤트 감지 규칙
model EventRule {
  id              String          @id @default(uuid())
  spreadsheetId   String
  spreadsheet     Spreadsheet     @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  name            String
  description     String?
  
  // 감지 대상
  targetType      TargetType      @default(SHEET)
  sheetId         String?
  cellRange       String?         // e.g., "A1:B10"
  cellCoordinates Json?           // 특정 셀 좌표 배열
  
  // 이벤트 타입
  eventTypes      EventType[]
  
  // 필터 조건
  filterConditions Json?          // 값 비교, 변화 유형 등
  batchMode       Boolean         @default(false)
  batchWindow     Int?            // 밀리초 단위 배치 윈도우
  
  // 웹훅 연결
  webhookId       String?
  webhook         Webhook?        @relation(fields: [webhookId], references: [id])
  
  // 플로우 연결
  flowId          String?
  flow            Flow?           @relation(fields: [flowId], references: [id])
  
  active          Boolean         @default(true)
  version         Int             @default(1)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  eventLogs       EventLog[]

  @@map("event_rules")
}

enum TargetType {
  SPREADSHEET
  SHEET
  RANGE
  CELL
  CELL_GROUP
}

enum EventType {
  CELL_CHANGE
  MULTI_CELL_CHANGE
  FORMULA_RECALC
  ROW_INSERT
  ROW_DELETE
  COL_INSERT
  COL_DELETE
}

// 이벤트 로그
model EventLog {
  id              String          @id @default(uuid())
  eventRuleId     String?
  eventRule       EventRule?      @relation(fields: [eventRuleId], references: [id])
  spreadsheetId   String
  sheetId         String
  eventType       EventType
  cellCoordinate  String          // e.g., "A1"
  previousValue   Json?
  newValue        Json?
  changedBy       String?
  changeMethod    String?         // "manual", "formula", "api", "import"
  transactionId   String
  createdAt       DateTime        @default(now())

  @@index([spreadsheetId, createdAt(sort: Desc)])
  @@index([transactionId])
  @@map("event_logs")
}

// 플로우 정의
model Flow {
  id              String          @id @default(uuid())
  spreadsheetId   String
  spreadsheet     Spreadsheet     @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  name            String
  description     String?
  
  // 노드 및 연결 정의 (JSON)
  nodes           Json            @default("[]") // FlowNode[]
  edges           Json            @default("[]") // FlowEdge[]
  
  active          Boolean         @default(true)
  version         Int             @default(1)
  createdById     String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  eventRules      EventRule[]
  executions      FlowExecution[]
  versions        FlowVersion[]
  permissions     FlowPermission[]

  @@map("flows")
}

// 플로우 버전 히스토리
model FlowVersion {
  id              String          @id @default(uuid())
  flowId          String
  flow            Flow            @relation(fields: [flowId], references: [id], onDelete: Cascade)
  version         Int
  nodes           Json
  edges           Json
  snapshot        Json?           // 전체 플로우 스냅샷
  createdById     String
  createdAt       DateTime        @default(now())

  @@unique([flowId, version])
  @@map("flow_versions")
}

// 플로우 실행 로그
model FlowExecution {
  id              String          @id @default(uuid())
  flowId          String
  flow            Flow            @relation(fields: [flowId], references: [id], onDelete: Cascade)
  transactionId   String          @unique
  status          ExecutionStatus @default(RUNNING)
  triggerData     Json?
  startedAt       DateTime        @default(now())
  completedAt     DateTime?
  error           String?

  // Relations
  nodeExecutions  NodeExecution[]

  @@index([flowId, startedAt(sort: Desc)])
  @@map("flow_executions")
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// 노드별 실행 로그
model NodeExecution {
  id              String          @id @default(uuid())
  flowExecutionId String
  flowExecution   FlowExecution   @relation(fields: [flowExecutionId], references: [id], onDelete: Cascade)
  nodeId          String
  nodeType        String
  inputData       Json?
  outputData      Json?
  status          ExecutionStatus @default(RUNNING)
  error           String?
  startedAt       DateTime        @default(now())
  completedAt     DateTime?

  @@map("node_executions")
}

// 플로우 권한
model FlowPermission {
  id              String          @id @default(uuid())
  flowId          String
  flow            Flow            @relation(fields: [flowId], references: [id], onDelete: Cascade)
  userId          String
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  role            FlowRole

  @@unique([flowId, userId])
  @@map("flow_permissions")
}

enum FlowRole {
  VIEWER
  EDITOR
  OWNER
}

// =====================================================
// PHASE 1-3: ADVANCED SHEET FEATURES
// =====================================================

// 시트별 권한 관리
model SheetPermission {
  id        String              @id @default(uuid())
  sheetId   String
  sheet     Sheet               @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  userId    String?
  user      User?               @relation(fields: [userId], references: [id], onDelete: Cascade)
  email     String?             // 비등록 사용자 초대용
  role      SheetPermissionRole
  createdAt DateTime            @default(now())

  @@unique([sheetId, userId])
  @@unique([sheetId, email])
  @@map("sheet_permissions")
}

enum SheetPermissionRole {
  VIEWER      // 읽기 전용
  COMMENTER   // 댓글 전용
  EDITOR      // 편집 가능
}

// 시트 변경 내역 로그
model RevisionLog {
  id            String    @id @default(uuid())
  sheetId       String
  sheet         Sheet     @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  action        String    // CELL_UPDATE, ROW_INSERT, COL_DELETE, BULK_UPDATE 등
  targetRange   String?   // 영향받은 범위 (예: "A1:B10")
  previousData  Json?     // 이전 상태
  newData       Json?     // 새 상태
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  description   String?   // 변경 설명
  createdAt     DateTime  @default(now())

  @@index([sheetId, createdAt(sort: Desc)])
  @@map("revision_logs")
}

// 조건부 서식 규칙
model ConditionalRule {
  id          String    @id @default(uuid())
  sheetId     String
  sheet       Sheet     @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  name        String
  priority    Int       @default(0)   // 낮을수록 우선순위 높음
  ranges      String[]  // 적용 범위 (예: ["A1:Z100", "AA1:AZ50"])
  conditions  Json      // 조건 배열 [{type, operator, value}]
  format      Json      // 적용할 서식 {backgroundColor, textColor, bold, italic, ...}
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([sheetId])
  @@map("conditional_rules")
}

// 시트 간 참조
model CrossSheetReference {
  id            String    @id @default(uuid())
  sourceSheetId String
  sourceSheet   Sheet     @relation("SourceReferences", fields: [sourceSheetId], references: [id], onDelete: Cascade)
  sourceCell    String    // 참조하는 셀 (예: "A1")
  targetSheetId String
  targetSheet   Sheet     @relation("TargetReferences", fields: [targetSheetId], references: [id], onDelete: Cascade)
  targetCell    String    // 참조되는 셀 (예: "B5")
  formula       String?   // 원본 수식 (예: "='Sheet2'!B5")
  createdAt     DateTime  @default(now())

  @@index([sourceSheetId])
  @@index([targetSheetId])
  @@map("cross_sheet_references")
}

// 시트 자동화 규칙
model SheetAutomation {
  id          String    @id @default(uuid())
  sheetId     String
  sheet       Sheet     @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  name        String
  description String?
  trigger     Json      // 트리거 정의 {eventType, conditions}
  actions     Json      // 액션 배열 [{type, config}]
  active      Boolean   @default(true)
  runCount    Int       @default(0)
  lastRunAt   DateTime?
  createdById String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([sheetId])
  @@map("sheet_automations")
}

// 필터 프로필
model FilterProfile {
  id        String    @id @default(uuid())
  sheetId   String
  sheet     Sheet     @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  name      String
  filters   Json      // 필터 조건 배열 [{column, operator, value}]
  sortings  Json?     // 정렬 설정 [{column, direction}]
  hiddenCols Int[]    // 숨긴 열 인덱스
  hiddenRows Int[]    // 숨긴 행 인덱스
  isDefault Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([sheetId])
  @@map("filter_profiles")
}

// 시트 스냅샷
model SheetSnapshot {
  id          String    @id @default(uuid())
  sheetId     String
  sheet       Sheet     @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  name        String
  description String?
  data        Json      // 전체 시트 데이터 스냅샷
  parentId    String?   // 브랜치 부모 스냅샷
  isBranch    Boolean   @default(false)
  createdById String
  createdBy   User      @relation(fields: [createdById], references: [id])
  createdAt   DateTime  @default(now())

  @@index([sheetId])
  @@map("sheet_snapshots")
}

// 사용자 정의 명령어
model CustomCommand {
  id            String      @id @default(uuid())
  spreadsheetId String
  spreadsheet   Spreadsheet @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  name          String      // 명령어 이름 (예: "fill-dates")
  description   String?
  script        String      @db.Text  // JavaScript 코드
  shortcuts     String[]    // 단축키 배열 (예: ["Ctrl+Shift+D"])
  isGlobal      Boolean     @default(false)  // 전역 명령어 여부
  createdById   String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([spreadsheetId, name])
  @@map("custom_commands")
}

// 마스터 뷰
model MasterView {
  id              String      @id @default(uuid())
  spreadsheetId   String
  spreadsheet     Spreadsheet @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  name            String
  description     String?
  sourceSheets    Json        // [{sheetId, columnMappings, rowFilter}]
  syncEnabled     Boolean     @default(true)
  lastSyncAt      DateTime?
  createdById     String
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([spreadsheetId])
  @@map("master_views")
}

// 시트 뷰 모드
enum SheetViewMode {
  EDIT          // 편집 모드
  VIEW          // 읽기 전용 모드
  ANALYSIS      // 데이터 분석 모드
  PRESENTATION  // 프레젠테이션 모드
}

// =====================================================
// ADMIN FEATURES - SHEET ADVANCED MANAGEMENT
// =====================================================

// 시트 권한 정책 템플릿
model PermissionPolicy {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  rules       Json     // 세부 권한 규칙 {canEdit, canComment, canShare, canExport, ...}
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("permission_policies")
}

// 시트 잠금 상태
model SheetLock {
  id          String    @id @default(uuid())
  sheetId     String    @unique
  lockedById  String
  reason      String?
  lockedAt    DateTime  @default(now())
  expiresAt   DateTime?

  @@map("sheet_locks")
}

// 조건부 서식 정책
model ConditionalFormatPolicy {
  id              String   @id @default(uuid())
  name            String   @unique
  description     String?
  allowedColors   String[] // 허용된 색상 코드
  allowedFormulas String[] // 허용된 수식 패턴
  blockedFormulas String[] // 차단된 수식 패턴
  maxRulesPerSheet Int     @default(50)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("conditional_format_policies")
}

// UDF 승인 요청
model UDFApproval {
  id           String    @id @default(uuid())
  spreadsheetId String
  name         String
  description  String?
  code         String    @db.Text
  parameters   Json?     // 파라미터 정의
  requesterId  String
  status       UDFApprovalStatus @default(PENDING)
  reviewerId   String?
  reviewNotes  String?
  riskLevel    RiskLevel?
  riskDetails  Json?     // 위험 코드 분석 결과
  requestedAt  DateTime  @default(now())
  reviewedAt   DateTime?

  @@index([spreadsheetId])
  @@index([status])
  @@map("udf_approvals")
}

enum UDFApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  REVOKED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// AI 모델 레지스트리
model AIModelConfig {
  id          String   @id @default(uuid())
  name        String   @unique
  modelType   AIModelType
  provider    AIProvider
  modelId     String   // 실제 모델 ID (gpt-4, gemini-pro 등)
  version     String
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)
  config      Json?    // 모델별 설정 (temperature, maxTokens 등)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("ai_model_configs")
}

enum AIModelType {
  FORMULA_SUGGEST    // 수식 추천
  SHEET_GENERATE     // 시트 생성
  DATA_ANALYSIS      // 데이터 분석
  CHAT_ASSISTANT     // 채팅 도우미
}

enum AIProvider {
  OPENAI
  GEMINI
  ANTHROPIC
  CUSTOM
}

// 프롬프트 템플릿
model PromptTemplate {
  id          String   @id @default(uuid())
  name        String   @unique
  category    PromptCategory
  content     String   @db.Text
  variables   String[] // 템플릿 변수 목록
  description String?
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("prompt_templates")
}

enum PromptCategory {
  SHEET_CREATION
  FORMULA_GENERATION
  DATA_ANALYSIS
  CHART_SUGGESTION
  AUTOMATION
  CUSTOM
}

// 피벗뷰 정책
model PivotPolicy {
  id                String   @id @default(uuid())
  name              String?
  userId            String?  // null이면 전역 정책
  maxPivotsPerSheet Int      @default(10)
  maxPivotsPerUser  Int      @default(50)
  allowedAggregates String[] // SUM, AVG, COUNT, MIN, MAX 등
  maxRowsForPivot   Int      @default(100000)
  isGlobal          Boolean  @default(false)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("pivot_policies")
}

// 사용자/시트 할당량
model Quota {
  id          String    @id @default(uuid())
  targetType  QuotaTargetType
  targetId    String    // userId 또는 sheetId
  maxRows     Int       @default(100000)
  maxColumns  Int       @default(1000)
  maxCells    Int       @default(10000000)
  maxFileSize Int       @default(104857600) // 100MB
  usedRows    Int       @default(0)
  usedColumns Int       @default(0)
  usedCells   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([targetType, targetId])
  @@map("quotas")
}

enum QuotaTargetType {
  USER
  SHEET
  SPREADSHEET
}

// 매크로 승인
model MacroApproval {
  id           String    @id @default(uuid())
  commandId    String?   // CustomCommand 참조
  spreadsheetId String
  name         String
  script       String    @db.Text
  description  String?
  requesterId  String
  status       MacroApprovalStatus @default(PENDING)
  reviewerId   String?
  reviewNotes  String?
  lintResults  Json?     // 린트 결과 {errors: [], warnings: []}
  riskLevel    RiskLevel?
  requestedAt  DateTime  @default(now())
  reviewedAt   DateTime?

  @@index([spreadsheetId])
  @@index([status])
  @@map("macro_approvals")
}

enum MacroApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  REVOKED
}

// API 사용량 추적
model APIUsage {
  id              String   @id @default(uuid())
  spreadsheetId   String?
  userId          String?
  endpoint        String
  method          String
  statusCode      Int
  responseTimeMs  Int
  requestSize     Int?
  responseSize    Int?
  userAgent       String?
  ipAddress       String?
  timestamp       DateTime @default(now())

  @@index([spreadsheetId, timestamp])
  @@index([userId, timestamp])
  @@index([endpoint, timestamp])
  @@map("api_usage")
}

// 시트 활동 세션
model SheetSession {
  id            String    @id @default(uuid())
  spreadsheetId String
  sheetId       String?
  userId        String
  sessionType   SessionType @default(EDIT)
  startedAt     DateTime  @default(now())
  lastActiveAt  DateTime  @default(now())
  endedAt       DateTime?
  editCount     Int       @default(0)
  viewCount     Int       @default(0)
  metadata      Json?     // 추가 세션 정보

  @@index([spreadsheetId, lastActiveAt])
  @@index([userId, lastActiveAt])
  @@map("sheet_sessions")
}

enum SessionType {
  VIEW
  EDIT
  COLLABORATION
}

// 스냅샷 보존 정책
model SnapshotRetentionPolicy {
  id                  String   @id @default(uuid())
  name                String   @unique
  description         String?
  maxSnapshotsPerSheet Int     @default(50)
  retentionDays       Int      @default(90)
  autoDeleteEnabled   Boolean  @default(true)
  isDefault           Boolean  @default(false)
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("snapshot_retention_policies")
}

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String?
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  isAdmin       Boolean   @default(false)
  
  // Profile
  language      String    @default("ko")
  theme         String    @default("light")
  contact       String?


  // Relations
  ownedSpreadsheets   Spreadsheet[]   @relation("SpreadsheetOwner")
  permissions         Permission[]
  comments            Comment[]
  versions            Version[]
  sessions            Session[]
  auditLogs           AuditLog[]
  favorites           Favorite[]
  
  roleId              String?
  role                Role?           @relation(fields: [roleId], references: [id])
  flowPermissions     FlowPermission[]
}

model Session {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshToken  String    @unique
  expiresAt     DateTime
  createdAt     DateTime  @default(now())

  @@map("sessions")
}

// Spreadsheet model
model Spreadsheet {
  id            String    @id @default(uuid())
  name          String
  ownerId       String
  owner         User      @relation("SpreadsheetOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  isPublic      Boolean   @default(false)
  publicToken   String?   @unique
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // For soft delete

  // Relations
  sheets        Sheet[]
  permissions   Permission[]
  versions      Version[]
  favorites     Favorite[]
  webhooks      Webhook[]
  eventRules    EventRule[]
  flows         Flow[]
  embedConfig   EmbedConfig?

  @@map("spreadsheets")
}

// Embed Configuration - 시트 임베딩 설정
model EmbedConfig {
  id              String      @id @default(uuid())
  spreadsheetId   String      @unique
  spreadsheet     Spreadsheet @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  embedToken      String      @unique @default(uuid())
  enabled         Boolean     @default(true)
  
  // 표시 옵션
  showToolbar     Boolean     @default(false)
  showTabs        Boolean     @default(true)
  showGridlines   Boolean     @default(true)
  
  // 제한 옵션
  allowedDomains  String[]    @default([])  // 빈 배열 = 모든 도메인 허용
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@map("embed_configs")
}

model Favorite {
  id            String      @id @default(uuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  spreadsheetId String
  spreadsheet   Spreadsheet @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  createdAt     DateTime    @default(now())

  @@unique([userId, spreadsheetId])
  @@map("favorites")
}

// Sheet model (tabs within a spreadsheet)
model Sheet {
  id              String    @id @default(uuid())
  spreadsheetId   String
  spreadsheet     Spreadsheet @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  name            String
  index           Int       @default(0)
  rowCount        Int       @default(1000)
  colCount        Int       @default(26)
  frozenRows      Int       @default(0)
  frozenCols      Int       @default(0)
  defaultRowHeight Int      @default(25)
  defaultColWidth  Int      @default(100)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  cells           Cell[]
  comments        Comment[]
  rowMeta         RowMeta[]
  colMeta         ColMeta[]
  charts          Chart[]
  pivotTables     PivotTable[]

  @@unique([spreadsheetId, index])
  @@map("sheets")
}

// Cell model
model Cell {
  id            String    @id @default(uuid())
  sheetId       String
  sheet         Sheet     @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  row           Int
  col           Int
  value         Json?
  formula       String?
  format        Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([sheetId, row, col])
  @@index([sheetId])
  @@map("cells")
}

// Chart model - 시트에 포함된 차트
model Chart {
  id              String    @id @default(uuid())
  sheetId         String
  sheet           Sheet     @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  type            String    // bar, line, pie, doughnut
  x               Int       @default(100)
  y               Int       @default(100)
  width           Int       @default(400)
  height          Int       @default(300)
  data            Json      // 차트 데이터 (labels, datasets)
  options         Json?     // 차트 옵션
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([sheetId])
  @@map("charts")
}

// PivotTable model - 피벗테이블 설정
model PivotTable {
  id              String    @id @default(uuid())
  sheetId         String
  sheet           Sheet     @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  name            String?
  config          Json      // PivotConfig (rows, columns, values, aggregation)
  sourceRange     String?   // 원본 데이터 범위 (예: "A1:D10")
  targetCell      String?   // 결과가 배치될 시작 셀 (예: "F1")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([sheetId])
  @@map("pivot_tables")
}

// Row metadata (height, hidden)
model RowMeta {
  id            String    @id @default(uuid())
  sheetId       String
  sheet         Sheet     @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  row           Int
  height        Int?
  hidden        Boolean   @default(false)

  @@unique([sheetId, row])
  @@map("row_meta")
}

// Column metadata (width, hidden)
model ColMeta {
  id            String    @id @default(uuid())
  sheetId       String
  sheet         Sheet     @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  col           Int
  width         Int?
  hidden        Boolean   @default(false)

  @@unique([sheetId, col])
  @@map("col_meta")
}

// Permission model
model Permission {
  id              String    @id @default(uuid())
  spreadsheetId   String
  spreadsheet     Spreadsheet @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  userId          String?
  user            User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  email           String?   // For sharing with non-registered users
  role            PermissionRole
  inviteToken     String?   @unique
  expiresAt       DateTime?
  createdAt       DateTime  @default(now())

  @@unique([spreadsheetId, userId])
  @@unique([spreadsheetId, email])
  @@map("permissions")
}

enum PermissionRole {
  VIEWER
  COMMENTER
  EDITOR
  OWNER
}

// Version/History model
model Version {
  id              String    @id @default(uuid())
  spreadsheetId   String
  spreadsheet     Spreadsheet @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  name            String?
  snapshot        Json      // CRDT state or cell data snapshot
  createdById     String
  createdBy       User      @relation(fields: [createdById], references: [id])
  createdAt       DateTime  @default(now())

  @@index([spreadsheetId, createdAt(sort: Desc)])
  @@map("versions")
}

// Comment model
model Comment {
  id              String    @id @default(uuid())
  sheetId         String
  sheet           Sheet     @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  row             Int
  col             Int
  content         String
  authorId        String
  author          User      @relation(fields: [authorId], references: [id])
  parentId        String?
  parent          Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies         Comment[] @relation("CommentReplies")
  resolved        Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([sheetId, row, col])
  @@map("comments")
}

// System Configuration (Global Settings)
model SystemConfig {
  key           String    @id
  value         String // JSON string or simple value
  description   String?
  updatedAt     DateTime  @updatedAt

  @@map("system_config")
}

// Audit Logs
model AuditLog {
  id            String    @id @default(uuid())
  userId        String?
  user          User?     @relation(fields: [userId], references: [id])
  action        String    // e.g., "USER_CREATED", "SHEET_DELETED"
  resource      String?   // e.g., "User: 123", "Sheet: ABC"
  details       Json?     // Metadata
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime  @default(now())

  @@index([createdAt(sort: Desc)])
  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}

// Role Based Access Control
model Role {
  id            String    @id @default(uuid())
  name          String    @unique // e.g., "ADMIN", "MANAGER", "USER"
  description   String?
  permissions   Json      // List of allowed actions or permission matrix
  isSystem      Boolean   @default(false) // System roles cannot be deleted
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  users         User[]

  @@map("roles")
}

// System Notices / Announcements
model Notice {
  id            String    @id @default(uuid())
  title         String
  content       String    @db.Text
  type          NoticeType @default(INFO)
  active        Boolean   @default(true)
  startDate     DateTime?
  endDate       DateTime?
  authorId      String
  // author        User      @relation(fields: [authorId], references: [id]) // Optional: link to creator
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("notices")
}

enum NoticeType {
  INFO
  WARNING
  URGENT
  MAINTENANCE
}

// Spreadsheet Templates
model Template {
  id            String    @id @default(uuid())
  name          String
  description   String?
  category      String    @default("General")
  data          Json      // The spreadsheet data structure
  thumbnail     String?   // URL or base64
  isPublic      Boolean   @default(true)
  order         Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("templates")
}

// =====================================================
// WORKFLOW AUTOMATION SYSTEM
// =====================================================

// 웹훅 설정
model Webhook {
  id              String          @id @default(uuid())
  spreadsheetId   String
  spreadsheet     Spreadsheet     @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  name            String
  url             String
  secret          String
  events          String[]        // 이벤트 타입 배열
  
  // 재시도 정책
  maxRetries      Int             @default(3)
  retryBackoff    String          @default("exponential") // linear, exponential
  
  active          Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  eventRules      EventRule[]
  executions      WebhookExecution[]
  deadLetterQueue DeadLetterItem[]

  @@map("webhooks")
}

// 웹훅 실행 로그
model WebhookExecution {
  id              String          @id @default(uuid())
  webhookId       String
  webhook         Webhook         @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  transactionId   String
  payload         Json
  response        Json?
  statusCode      Int?
  success         Boolean         @default(false)
  retryCount      Int             @default(0)
  executedAt      DateTime        @default(now())

  @@index([webhookId, executedAt(sort: Desc)])
  @@map("webhook_executions")
}

// Dead-letter 큐
model DeadLetterItem {
  id              String          @id @default(uuid())
  webhookId       String
  webhook         Webhook         @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  payload         Json
  error           String
  createdAt       DateTime        @default(now())

  @@map("dead_letter_queue")
}

// 이벤트 감지 규칙
model EventRule {
  id              String          @id @default(uuid())
  spreadsheetId   String
  spreadsheet     Spreadsheet     @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  name            String
  description     String?
  
  // 감지 대상
  targetType      TargetType      @default(SHEET)
  sheetId         String?
  cellRange       String?         // e.g., "A1:B10"
  cellCoordinates Json?           // 특정 셀 좌표 배열
  
  // 이벤트 타입
  eventTypes      EventType[]
  
  // 필터 조건
  filterConditions Json?          // 값 비교, 변화 유형 등
  batchMode       Boolean         @default(false)
  batchWindow     Int?            // 밀리초 단위 배치 윈도우
  
  // 웹훅 연결
  webhookId       String?
  webhook         Webhook?        @relation(fields: [webhookId], references: [id])
  
  // 플로우 연결
  flowId          String?
  flow            Flow?           @relation(fields: [flowId], references: [id])
  
  active          Boolean         @default(true)
  version         Int             @default(1)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  eventLogs       EventLog[]

  @@map("event_rules")
}

enum TargetType {
  SPREADSHEET
  SHEET
  RANGE
  CELL
  CELL_GROUP
}

enum EventType {
  CELL_CHANGE
  MULTI_CELL_CHANGE
  FORMULA_RECALC
  ROW_INSERT
  ROW_DELETE
  COL_INSERT
  COL_DELETE
}

// 이벤트 로그
model EventLog {
  id              String          @id @default(uuid())
  eventRuleId     String?
  eventRule       EventRule?      @relation(fields: [eventRuleId], references: [id])
  spreadsheetId   String
  sheetId         String
  eventType       EventType
  cellCoordinate  String          // e.g., "A1"
  previousValue   Json?
  newValue        Json?
  changedBy       String?
  changeMethod    String?         // "manual", "formula", "api", "import"
  transactionId   String
  createdAt       DateTime        @default(now())

  @@index([spreadsheetId, createdAt(sort: Desc)])
  @@index([transactionId])
  @@map("event_logs")
}

// 플로우 정의
model Flow {
  id              String          @id @default(uuid())
  spreadsheetId   String
  spreadsheet     Spreadsheet     @relation(fields: [spreadsheetId], references: [id], onDelete: Cascade)
  name            String
  description     String?
  
  // 노드 및 연결 정의 (JSON)
  nodes           Json            @default("[]") // FlowNode[]
  edges           Json            @default("[]") // FlowEdge[]
  
  active          Boolean         @default(true)
  version         Int             @default(1)
  createdById     String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  eventRules      EventRule[]
  executions      FlowExecution[]
  versions        FlowVersion[]
  permissions     FlowPermission[]

  @@map("flows")
}

// 플로우 버전 히스토리
model FlowVersion {
  id              String          @id @default(uuid())
  flowId          String
  flow            Flow            @relation(fields: [flowId], references: [id], onDelete: Cascade)
  version         Int
  nodes           Json
  edges           Json
  snapshot        Json?           // 전체 플로우 스냅샷
  createdById     String
  createdAt       DateTime        @default(now())

  @@unique([flowId, version])
  @@map("flow_versions")
}

// 플로우 실행 로그
model FlowExecution {
  id              String          @id @default(uuid())
  flowId          String
  flow            Flow            @relation(fields: [flowId], references: [id], onDelete: Cascade)
  transactionId   String          @unique
  status          ExecutionStatus @default(RUNNING)
  triggerData     Json?
  startedAt       DateTime        @default(now())
  completedAt     DateTime?
  error           String?

  // Relations
  nodeExecutions  NodeExecution[]

  @@index([flowId, startedAt(sort: Desc)])
  @@map("flow_executions")
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// 노드별 실행 로그
model NodeExecution {
  id              String          @id @default(uuid())
  flowExecutionId String
  flowExecution   FlowExecution   @relation(fields: [flowExecutionId], references: [id], onDelete: Cascade)
  nodeId          String
  nodeType        String
  inputData       Json?
  outputData      Json?
  status          ExecutionStatus @default(RUNNING)
  error           String?
  startedAt       DateTime        @default(now())
  completedAt     DateTime?

  @@map("node_executions")
}

// 플로우 권한
model FlowPermission {
  id              String          @id @default(uuid())
  flowId          String
  flow            Flow            @relation(fields: [flowId], references: [id], onDelete: Cascade)
  userId          String
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  role            FlowRole

  @@unique([flowId, userId])
  @@map("flow_permissions")
}

enum FlowRole {
  VIEWER
  EDITOR
  OWNER
}
